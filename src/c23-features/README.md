# C23の新機能

## 対応C規格

- **主要対象:** C23
- **学習内容:** bool型、typeof演算子、nullptr、2進数リテラル、その他の新機能

## 学習目標
この章を完了すると、以下のことができるようになります。

- C23で標準化されたbool型を使用できる
- typeof演算子で型を扱える
- nullptrを使った型安全なコードが書ける
- 2進数リテラルを活用できる
- C23の新機能を実践的に活用できる

## 概要と詳細

### C23とは？

C23は、C言語の最新の規格（2024年予定）です。「なぜ新しい規格が必要なの？」と思うかもしれません。実は、プログラミングの世界も日々進化しているのです！

#### 新しい規格が生まれる理由
プログラミング言語の規格は、スマートフォンのOSアップデートのようなものです。

1. **新しいニーズへの対応**

   - より安全なプログラムを書きたい
   - より短く、わかりやすいコードを書きたい
   - 他の言語の便利な機能を取り入れたい

2. **過去の問題の修正**

   - これまでの規格で不便だった部分を改善
   - よくあるバグを防ぐ機能の追加
   - 開発者の要望を反映

3. **時代の変化への適応**

   - マルチコアCPUの普及
   - より高度なコンパイラ技術
   - セキュリティ要求の高まり

### 主要な新機能
C23では、初心者にも嬉しい機能がたくさん追加されました！

#### 1. bool型の標準化 - 真偽値がより使いやすく
これまでC言語でtrue/falseを使うには、特別なヘッダーファイルが必要でした。C23では、それが不要になります！

**日常生活での例え**。

- 従来：「はい」「いいえ」を使うために辞書が必要
- C23：「はい」「いいえ」が最初から使える

```c
/* C90/C99 - これまでの書き方 */
#include <stdbool.h>  /* このヘッダーが必要だった */
bool is_student = true;

/* C23 - 新しい書き方 */
bool is_student = true;  /* ヘッダー不要！すぐ使える */
```

**なぜ便利？**

- コードがシンプルになる
- 他の言語（Java、C++など）と同じ感覚で使える
- 初心者にも直感的

#### 2. typeof演算子 - 型を自動で判別
変数の型を自動的に取得できる便利な機能です。

**日常生活での例え**。

- 「この箱と同じサイズの箱をもう一つください」と言えるようになった
- 箱のサイズを測る必要がない

```c
int age = 20;
typeof(age) another_age = 25;  /* another_ageは自動的にint型になる */

double price = 19.99;
typeof(price) tax = 1.10;      /* taxは自動的にdouble型になる */
```

**よくある使い方**。

```c
/* 型安全なスワップマクロ */
#define SWAP(a, b) do { \
    typeof(a) temp = (a); \
    (a) = (b); \
    (b) = temp; \
} while(0)

/* 使用例 */
int x = 10, y = 20;
SWAP(x, y);  /* xとyの値が入れ替わる */
```

#### 3. nullptr定数 - より安全なNULLポインタ
ポインタが「何も指していない」ことを示す、より安全な方法です。

**日常生活での例え**。

- NULL：「住所なし」（でも0番地と区別がつかない）
- nullptr：「住所なし」（明確に住所がないことを示す）

```c
/* 従来の方法 */
int *p1 = NULL;     /* NULLは実は0かもしれない */

/* C23の新しい方法 */
int *p2 = nullptr;  /* 明確にポインタ用のnull値 */
```

**なぜ安全？**

```c
/* 従来の問題 */
void func(int x) { printf("整数: %d\n", x); }
void func(int *p) { printf("ポインタ\n"); }
func(NULL);  /* どちらが呼ばれる？曖昧！ */

/* C23では */
func(nullptr);  /* 確実にポインタ版が呼ばれる */
```

#### 4. 2進数リテラル - ビット操作が直感的に
2進数を直接書けるようになりました！

**日常生活での例え**。

- 従来：「8個のスイッチで、1番目と3番目をON」→ 5と計算
- C23：「8個のスイッチで、00000101」→ そのまま書ける

```c
/* 従来の書き方 */
int flags = 5;           /* 何を表しているか分かりにくい */
int mask = 0xAA;        /* 16進数で書く必要があった */

/* C23の新しい書き方 */
int flags = 0b00000101;  /* 1番目と3番目のビットがON、一目瞭然！ */
int mask = 0b10101010;   /* ビットパターンが見やすい */
```

**実用例 - ファイルのアクセス権限**。

```c
/* 読み取り、書き込み、実行の権限を2進数で表現 */
#define READ_PERMISSION  0b100  /* 読み取り可能 */
#define WRITE_PERMISSION 0b010  /* 書き込み可能 */
#define EXEC_PERMISSION  0b001  /* 実行可能 */

/* 権限の組み合わせ */
int user_permissions = READ_PERMISSION | WRITE_PERMISSION;  /* 読み書き可能 */
```

### その他の新機能
C23には他にも多くの新機能があります。

#### 5. auto型推論（制限付き）
変数の型を自動的に推論する機能（ただし制限あり）。

```c
auto x = 42;      /* xはint型と推論される */
auto y = 3.14;    /* yはdouble型と推論される */
```

#### 6. constexpr - コンパイル時定数
コンパイル時に値が確定する定数を定義できます。

```c
constexpr int ARRAY_SIZE = 100;
int array[ARRAY_SIZE];  /* コンパイル時にサイズが決まる */
```

#### 7. 新しいプリプロセッサ機能
条件付きコンパイルがより便利に。

```c
/* マクロが定義されているかチェック */
#elifdef DEBUG
    printf("デバッグモード\n");
#elifndef RELEASE
    printf("リリースモードではない\n");
#endif
```

### 初心者が陥りやすい間違い

#### 1. コンパイラのサポート確認を忘れる

```c
/* NG: コンパイラがC23をサポートしていない場合 */
bool flag = true;  /* エラー: 'bool' undeclared */

/* OK: サポート確認とフォールバック */
#if __STDC_VERSION__ >= 202300L
    bool flag = true;  /* C23 */
#else
    #include <stdbool.h>
    bool flag = true;  /* C99以前 */
#endif
```

#### 2. 古い書き方と新しい書き方の混在

```c
/* NG: 混在は避ける */
int *p1 = NULL;     /* 古い書き方 */
int *p2 = nullptr;  /* 新しい書き方 */

/* OK: 統一する */
int *p1 = nullptr;
int *p2 = nullptr;
```

#### 3. 2進数リテラルの桁数ミス

```c
/* NG: ビット数を間違えやすい */
unsigned char byte = 0b111111111;  /* 9ビット！オーバーフロー */

/* OK: 8ビットに収める */
unsigned char byte = 0b11111111;   /* 8ビット、OK */

/* より良い: アンダースコアで区切る（C23） */
unsigned char byte = 0b1111_1111;  /* 見やすい！ */
```

### 学習のコツ

1. **段階的に学ぶ**

   - まずはbool型から始める
   - 慣れたらtypeof演算子を試す
   - 最後に高度な機能へ

2. **コンパイラの確認**

   - 使用するコンパイラのバージョンを確認
   - C23サポート状況をチェック
   - 必要に応じて新しいバージョンをインストール

3. **実際に試す**

   - 小さなプログラムで新機能を試す
   - エラーメッセージをよく読む
   - 動作を確認しながら理解を深める

### まとめ
C23の新機能は、C言語をより使いやすく、安全にするためのものです。すべてを一度に覚える必要はありません。まずは基本的な機能（bool型、2進数リテラル）から始めて、徐々に高度な機能を学んでいきましょう。

新しい機能を使うことで、より読みやすく、バグの少ないプログラムが書けるようになります！

## 実例コード
完全な実装例は以下のファイルを参照してください。

### C23新機能のデモ

- [bool_basics.c](examples/bool_basics.c) - bool型の基本使用
- [typeof_demo.c](examples/typeof_demo.c) - typeof演算子の活用
- [nullptr_example.c](examples/nullptr_example.c) - nullptrの使用例
- [binary_literals.c](examples/binary_literals.c) - 2進数リテラルの実例

## コンパイル方法
この章はC23専用です。以下のコマンドでコンパイルしてください。

```bash
# 個別ファイルのコンパイル
gcc -std=c23 -Wall -Wextra -pedantic source.c -o output

# Makefileを使用
make all          # すべてコンパイル
make test         # C23サポートテスト
make run-all      # すべて実行
```

### コンパイラサポート状況
C23は新しい規格のため、コンパイラサポートは発展途上です。

- **GCC**: 13以降で部分サポート（`-std=c23`）
- **Clang**: 16以降で部分サポート（`-std=c23`）
- **MSVC**: 未対応（2024年現在）

## 学習フローとコンパイル方法

### 推奨学習順序

1. **理論学習**: README.mdで基本概念を理解
2. **サンプルコード**: examples/の基本例を確認
3. **演習課題**: exercises/README.mdで課題を確認
4. **実装練習**: solutions/の解答例を参考に自分で実装

## 注意事項

1. **コンパイラ依存**: すべてのC23機能がサポートされているとは限りません
2. **移植性**: 古いコンパイラでは動作しません
3. **学習順序**: C90/C99の基礎を理解してから学習することを推奨

## C90/C99/C11からの移行

### bool型

```c
/* C90 */
#define TRUE 1
#define FALSE 0
int flag = TRUE;

/* C99 */
#include <stdbool.h>
bool flag = true;

/* C23 */
bool flag = true;  /* ヘッダー不要 */
```

### NULLポインタ

```c
/* C90/C99/C11 */
int *p = NULL;

/* C23 */
int *p = nullptr;
```

### 型の取得

```c
/* C11: _Generic */
#define TYPE_NAME(x) _Generic((x), \
    int: "int", \
    double: "double", \
    default: "other")

/* C23: typeof */
typeof(x) y;  /* xと同じ型 */
```

**注**: この章はオプション的な内容です。実務では、使用するコンパイラのC23サポート状況を確認してから活用してください。

## 参考資料

- examples/ - 実装例（C23対応）
- exercises/ - 演習問題
- solutions/ - 解答例
- [C23規格ドラフト](https://www.open-std.org/jtc1/sc22/wg14/www/docs/n3096.pdf)
- [C23新機能の概要](https://en.cppreference.com/w/c/23)
- コンパイラのドキュメント（GCC、Clang）

## 演習問題

この章の内容を理解したら、[演習問題](exercises/)に挑戦してみましょう。

- 基礎問題：基本的な文法や概念の確認
- 応用問題：より実践的なプログラムの作成
- チャレンジ問題：高度な理解と実装力が必要な問題