# 第16章 演習問題: C23の新機能

## 演習の目的
- C23標準で導入された新機能を理解する
- bool型、2進数リテラル、typeof演算子、nullptrを活用する
- モダンなCプログラミングスタイルを習得する
- より安全で表現力豊かなコードを書く

## 基礎問題

### 問題16-1: bool型の活用
bool型を使用して、簡単な状態管理システムを作成してください。

**要件:**
- システムの各種状態をbool型で管理
- 状態の組み合わせによる判定ロジック
- 状態表示関数の実装
- 状態遷移の履歴記録

**実装のヒント:**
```c
typedef struct {
    bool is_connected;
    bool is_authenticated;
    bool has_permission;
    bool is_busy;
} SystemStatus;
```

**期待される出力例:**
```
=== bool型を使った状態管理システム ===

初期状態:
接続: false
認証: false
権限: false
ビジー: false

システム接続中...
接続: true
認証: false (認証が必要です)

ユーザー認証...
接続: true
認証: true
権限: false (権限の付与待ち)

管理者権限を付与...
接続: true
認証: true
権限: true
ビジー: false

操作可能状態: Yes

=== 状態遷移履歴 ===
[00:00:00] システム起動
[00:00:01] 接続確立
[00:00:03] 認証成功
[00:00:05] 権限付与
[00:00:10] 処理開始 (ビジー: true)
[00:00:15] 処理完了 (ビジー: false)
```

### 問題16-2: ビット操作と2進数リテラル
2進数リテラルを使用して、8ビットのフラグ管理システムを作成してください。

**要件:**
- 各ビットが異なる機能のON/OFFを表す
- ビットの設定、クリア、トグル、チェック関数
- 現在の状態を2進数で表示
- 複数フラグの一括操作

**実装例:**
```c
#define FLAG_READ    0b00000001
#define FLAG_WRITE   0b00000010
#define FLAG_EXECUTE 0b00000100
```

**期待される出力例:**
```
=== 2進数リテラルを使ったフラグ管理 ===

権限フラグの定義:
FLAG_READ    = 0b00000001 (0x01)
FLAG_WRITE   = 0b00000010 (0x02)
FLAG_EXECUTE = 0b00000100 (0x04)
FLAG_DELETE  = 0b00001000 (0x08)

初期フラグ: 0b00000000

読み取り権限を設定:
現在のフラグ: 0b00000001 (READ)

書き込み権限を追加:
現在のフラグ: 0b00000011 (READ | WRITE)

すべての権限を設定:
現在のフラグ: 0b00001111 (READ | WRITE | EXECUTE | DELETE)

実行権限をトグル:
現在のフラグ: 0b00001011 (READ | WRITE | DELETE)

権限チェック:
- 読み取り: ○
- 書き込み: ○
- 実行: ×
- 削除: ○

一括操作 (読み取り専用に設定):
現在のフラグ: 0b00000001 (READ)
```

## 応用問題

### 問題16-3: typeof演算子の応用
typeof演算子を使用して、汎用的なデータ構造操作マクロを作成してください。

**要件:**
- 配列の最大値・最小値を求めるマクロ
- 2つの変数を安全に交換するマクロ
- 配列要素の合計を計算するマクロ
- 型安全な比較関数マクロ

**実装例:**
```c
#define ARRAY_MAX(arr, size) ({ \
    typeof(arr[0]) max = arr[0]; \
    /* 実装を完成させる */ \
    max; \
})
```

**期待される出力例:**
```
=== typeof演算子の汎用マクロ ===

整数配列のテスト:
配列: [34, 67, 12, 89, 45, 23, 78, 56]
最大値: 89
最小値: 12
合計: 404

浮動小数点配列のテスト:
配列: [3.14, 2.71, 1.41, 1.73, 2.23]
最大値: 3.14
最小値: 1.41
合計: 11.22

安全な変数交換:
交換前: a=10, b=20
交換後: a=20, b=10

文字列の交換:
交換前: s1="Hello", s2="World"
交換後: s1="World", s2="Hello"

型安全な比較:
compare(10, 20) = -1
compare(3.14, 3.14) = 0
compare('Z', 'A') = 1
```

### 問題16-4: nullptr安全プログラミング
nullptrを活用して、安全なリンクリスト操作関数を作成してください。

**要件:**
- ノードの追加、削除、検索
- すべてのポインタ操作でnullptrチェック
- エラーハンドリングの実装
- メモリリークの防止

**実装のヒント:**
- 従来のNULLの代わりにnullptrを使用
- 戻り値でのエラー通知

**期待される出力例:**
```
=== nullptr安全リンクリスト ===

要素を追加: 10
要素を追加: 20
要素を追加: 30

リストの内容: 10 -> 20 -> 30 -> nullptr

要素20を検索... 見つかりました
要素40を検索... 見つかりません

要素20を削除...
リストの内容: 10 -> 30 -> nullptr

空のリストに対する操作:
削除試行: エラー - リストが空です
検索試行: エラー - リストが空です

nullptrチェック統計:
- nullptrチェック総数: 42
- nullptr検出回数: 7
- 安全に処理された操作: 100%

メモリリーク検査: OK (すべてのメモリが解放されました)
```

### 問題16-5: デジット区切り記号の活用
デジット区切り記号を使って、大きな数値を扱うプログラムを作成してください。

**要件:**
- 10進数、16進数、2進数での表記
- 可読性の高い定数定義
- ビットマスクの定義
- メモリサイズの計算

**実装例:**
```c
#define MEMORY_SIZE 16'777'216  // 16MB
#define MASK_32BIT  0xFFFF'FFFF
#define PATTERN     0b1010'1010'1010'1010
```

**期待される出力例:**
```
=== デジット区切り記号を使った数値表現 ===

大きな数値の定義:
人口: 7'825'000'000 人
メモリサイズ: 16'777'216 バイト (16MB)
国家予算: 106'600'000'000'000 円

16進数表記:
アドレス空間: 0xFFFF'FFFF'FFFF'FFFF
カラーコード: 0x00FF'00FF (緑とマゼンタ)

2進数表記:
ビットパターン: 0b1010'1010'1010'1010
マスク: 0b1111'1111'0000'0000

計算例:
16MB = 16'777'216 バイト
     = 16'384 KB
     = 16 MB

ビット演算:
0b1111'0000'1111'0000 AND 0b1010'1010'1010'1010
= 0b1010'0000'1010'0000
```

## チャレンジ問題

### 問題16-6: C23総合演習 - 設定管理システム
C23の複数の新機能を組み合わせた設定管理システムを作成してください。

**要件:**
- bool型で各種設定のON/OFF管理
- 2進数リテラルでフラグ管理
- nullptrで安全なポインタ操作
- typeof演算子でジェネリックな操作
- 設定の保存と読み込み機能

**機能要件:**
- 設定項目の動的追加・削除
- 設定のグループ化
- デフォルト値の管理
- 設定変更の通知機能

**期待される出力例:**
```
=== C23総合設定管理システム ===

設定グループ: Display
- brightness: true (bool)
- dark_mode: false (bool)
- resolution: 1920x1080
- refresh_rate: 60

設定グループ: Network
- wifi_enabled: true (bool)
- bluetooth_enabled: false (bool)
- airplane_mode: false (bool)

設定フラグ (2進数表示):
現在: 0b0000'0101 (WiFi | Brightness)

設定変更: dark_mode = true
通知: DisplaySettingsChanged -> dark_mode

設定の保存...
ファイル: settings.conf
保存完了 (チェックサム: 0xA5C3)

=== typeof演算子による汎用操作 ===
設定値の型安全な更新:
- 整数値: 60 -> 144 (成功)
- bool値: false -> true (成功)
- 文字列: "1920x1080" -> "2560x1440" (成功)
```

### 問題16-7: ビット演算デバッガ
教育的なビット演算デバッガを作成してください。

**要件:**
- 2進数リテラルでの入力サポート
- ビット演算の可視化
- ステップ実行機能
- 演算結果の詳細説明

**実装すべき演算:**
- AND, OR, XOR, NOT
- ビットシフト（左右）
- ビット回転
- ビットカウント

**期待される出力例:**
```
=== ビット演算デバッガ ===

入力方式を選択:
1. 2進数 (0b...)
2. 16進数 (0x...)
3. 10進数

選択: 1
値A: 0b1010'1100
値B: 0b1100'1010

=== ビット演算の可視化 ===

AND演算:
  1010 1100
& 1100 1010
-----------
  1000 1000 (0x88)

OR演算:
  1010 1100
| 1100 1010
-----------
  1110 1110 (0xEE)

XOR演算:
  1010 1100
^ 1100 1010
-----------
  0110 0110 (0x66)

NOT演算:
~ 1010 1100
-----------
  0101 0011 (0x53)

左シフト (2ビット):
1010 1100 << 2 = 1011 0000 (0xB0)
  ↑↑ 消失

右シフト (2ビット):
1010 1100 >> 2 = 0010 1011 (0x2B)
            消失 ↑↑

ビット数: A=5個, B=5個
```

## 提出方法
1. 各演習問題ごとに独立したCファイルを作成
2. ファイル名は `ex16_1.c`, `ex16_2.c` のような形式で
3. C23機能を使用する箇所には必ずコメントを記載
4. コンパイラのC23サポートを確認（gcc 13以降推奨）

## 学習のポイント
- C23の新機能は従来のCコードをより安全で読みやすくする
- bool型により意図が明確なコードが書ける
- 2進数リテラルはビット操作を直感的にする
- nullptrはポインタの安全性を向上させる
- typeof演算子により型安全なマクロが作成可能