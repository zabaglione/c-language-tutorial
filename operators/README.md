# 演算子と式

## 対応C規格
- **主要対象:** C90
- **学習内容:** 算術演算子、関係演算子、論理演算子、ビット演算子、演算子の優先順位

## 学習目標

この章を完了すると、以下のことができるようになります：

- さまざまな演算子の種類と使い方を理解する
- 演算子の優先順位と結合規則を把握する
- 複雑な式を正しく記述できる
- インクリメント・デクリメント演算子を適切に使える
- ビット演算の基本を理解する

## 理論解説

### 算術演算子

基本的な数値計算を実行する演算子です。

| 演算子 | 意味 | 例 | 結果 |
|--------|------|----|----- |
| `+` | 加算 | `5 + 3` | `8` |
| `-` | 減算 | `5 - 3` | `2` |
| `*` | 乗算 | `5 * 3` | `15` |
| `/` | 除算 | `7 / 3` | `2` (整数除算) |
| `%` | 剰余 | `7 % 3` | `1` |

#### 除算の注意点

```c
int a = 7, b = 3;
int result = a / b;        /* 結果: 2 (整数除算) */
double result = a / b;     /* 結果: 2.0 (整数除算後に型変換) */
double result = (double)a / b; /* 結果: 2.333... (実数除算) */
```

### 代入演算子

値を変数に代入する演算子です。

| 演算子 | 意味 | 例 | 等価な記述 |
|--------|------|----|-----------| 
| `=` | 代入 | `a = 5` | - |
| `+=` | 加算代入 | `a += 3` | `a = a + 3` |
| `-=` | 減算代入 | `a -= 2` | `a = a - 2` |
| `*=` | 乗算代入 | `a *= 2` | `a = a * 2` |
| `/=` | 除算代入 | `a /= 3` | `a = a / 3` |
| `%=` | 剰余代入 | `a %= 4` | `a = a % 4` |

```c
int count = 10;
count += 5;     /* count は 15 になる */
count *= 2;     /* count は 30 になる */
```

### インクリメント・デクリメント演算子

変数の値を増減させる演算子です。

| 演算子 | 意味 | 前置 | 後置 |
|--------|------|------|------|
| `++` | インクリメント | `++a` | `a++` |
| `--` | デクリメント | `--a` | `a--` |

#### 前置と後置の違い

```c
int a = 5, b = 5;
int x, y;

x = ++a;    /* a を先にインクリメント, x = 6, a = 6 */
y = b++;    /* b の値を先に使用, y = 5, b = 6 */
```

**C99版での詳細:** [increment_decrement_c99.c](solutions/increment_decrement_c99.c)

### 関係演算子

2つの値を比較する演算子です。結果は真（非0）または偽（0）になります。

| 演算子 | 意味 | 例 | 結果 |
|--------|------|----|----- |
| `==` | 等しい | `5 == 3` | `0` (偽) |
| `!=` | 等しくない | `5 != 3` | `1` (真) |
| `<` | より小さい | `5 < 3` | `0` (偽) |
| `<=` | 以下 | `5 <= 3` | `0` (偽) |
| `>` | より大きい | `5 > 3` | `1` (真) |
| `>=` | 以上 | `5 >= 3` | `1` (真) |

### 論理演算子

論理値（真偽）を操作する演算子です。

| 演算子 | 意味 | 例 | 説明 |
|--------|------|----|----- |
| `&&` | 論理積（AND） | `a && b` | a も b も真の場合のみ真 |
| `||` | 論理和（OR） | `a || b` | a または b が真なら真 |
| `!` | 論理否定（NOT） | `!a` | a が偽なら真、真なら偽 |

#### 短絡評価

```c
int a = 0, b = 10;

if (a != 0 && b / a > 5)   /* a が 0 なので、b / a は評価されない */
    /* 実行されない */
```

### ビット演算子

ビットレベルで値を操作する演算子です。

| 演算子 | 意味 | 例 | 説明 |
|--------|------|----|----- |
| `&` | ビットAND | `a & b` | 対応するビットが両方1の場合1 |
| `|` | ビットOR | `a | b` | 対応するビットのいずれかが1の場合1 |
| `^` | ビットXOR | `a ^ b` | 対応するビットが異なる場合1 |
| `~` | ビット反転 | `~a` | 各ビットを反転 |
| `<<` | 左シフト | `a << 2` | ビットを左に2つシフト |
| `>>` | 右シフト | `a >> 1` | ビットを右に1つシフト |

```c
unsigned char a = 5;    /* 00000101 */
unsigned char b = 3;    /* 00000011 */

printf("a & b = %d\n", a & b);  /* 1 (00000001) */
printf("a | b = %d\n", a | b);  /* 7 (00000111) */
printf("a ^ b = %d\n", a ^ b);  /* 6 (00000110) */
printf("~a = %d\n", ~a);        /* 250 (11111010) */
```

**C99版での詳細:** [bitwise_demo_c99.c](examples/bitwise_demo_c99.c)

### 条件演算子（三項演算子）

条件に基づいて値を選択する演算子です。

```c
条件 ? 真の場合の値 : 偽の場合の値
```

```c
int a = 3, b = 7;
int max = (a > b) ? a : b;  /* b が大きいので max = 7 */

printf("大きい方: %d\n", max);
```

**C99版での詳細:** [conditional_operator_c99.c](solutions/conditional_operator_c99.c)

### sizeof演算子

データ型や変数のサイズを取得する演算子です。

```c
printf("int のサイズ: %lu バイト\n", (unsigned long)sizeof(int));
printf("double のサイズ: %lu バイト\n", (unsigned long)sizeof(double));

int arr[10];
printf("配列のサイズ: %lu バイト\n", (unsigned long)sizeof(arr));
```

### 演算子の優先順位

演算子には優先順位があり、計算の順序に影響します。

| 優先順位 | 演算子 | 結合規則 |
|----------|--------|----------|
| 1 | `()` `[]` `->` `.` | 左から右 |
| 2 | `!` `~` `++` `--` `+` `-` `*` `&` `sizeof` `(型)` | 右から左 |
| 3 | `*` `/` `%` | 左から右 |
| 4 | `+` `-` | 左から右 |
| 5 | `<<` `>>` | 左から右 |
| 6 | `<` `<=` `>` `>=` | 左から右 |
| 7 | `==` `!=` | 左から右 |
| 8 | `&` | 左から右 |
| 9 | `^` | 左から右 |
| 10 | `|` | 左から右 |
| 11 | `&&` | 左から右 |
| 12 | `||` | 左から右 |
| 13 | `?:` | 右から左 |
| 14 | `=` `+=` `-=` `*=` `/=` `%=` `&=` `^=` `|=` `<<=` `>>=` | 右から左 |
| 15 | `,` | 左から右 |

#### 優先順位の例

```c
int result = 2 + 3 * 4;     /* 結果: 14 (乗算が先) */
int result = (2 + 3) * 4;  /* 結果: 20 (括弧が先) */
```

**C99版での詳細:** [precedence_demo_c99.c](examples/precedence_demo_c99.c)

## サンプルコード

### 演算子の基本使用例

プログラムファイル: [operators_demo.c](examples/operators_demo.c)  
C99版: [operators_demo_c99.c](examples/operators_demo_c99.c)

さまざまな演算子の使用方法を学習します。

### ビット演算の実例

プログラムファイル: [bitwise_demo.c](examples/bitwise_demo.c)  
C99版: [bitwise_demo_c99.c](examples/bitwise_demo_c99.c)

ビット演算の動作を可視化して確認します。

### 演算子優先順位の確認

プログラムファイル: [precedence_demo.c](examples/precedence_demo.c)  
C99版: [precedence_demo_c99.c](examples/precedence_demo_c99.c)

演算子の優先順位による計算結果の違いを確認します。

### コンパイルと実行

```bash
# C90準拠でコンパイル
gcc -std=c90 -Wall -Wextra -pedantic examples/operators_demo.c -o operators_demo

# C99準拠でコンパイル
gcc -std=c99 -Wall -Wextra -pedantic examples/operators_demo_c99.c -o operators_demo_c99

# 実行
./operators_demo
```

## 演習課題

演習課題の詳細は [exercises/README.md](exercises/README.md) を参照してください。

### 基礎問題

1. **四則演算計算機**
   - 2つの数値に対してすべての算術演算を実行するプログラムを作成してください

2. **比較と論理演算**
   - 2つの数値の中から最大値を求めるプログラムを作成してください

3. **インクリメント・デクリメント**
   - 前置と後置の違いを確認するプログラムを作成してください

### 応用問題

4. **ビット操作**
   - 整数の各ビットを表示するプログラムを作成してください

5. **条件演算子の活用**
   - 三項演算子を使って複雑な条件分岐を実装してください

6. **演算子優先順位**
   - 複雑な式の計算順序を確認するプログラムを作成してください

## 解答例

各演習問題の解答例は [solutions/](solutions/) ディレクトリにあります：

- [increment_decrement.c](solutions/increment_decrement.c) / [C99版](solutions/increment_decrement_c99.c)
- [operator_precedence.c](solutions/operator_precedence.c) / [C99版](solutions/operator_precedence_c99.c)
- [conditional_operator.c](solutions/conditional_operator.c) / [C99版](solutions/conditional_operator_c99.c)

## コンパイル方法

この章では以下のMakefileを使用してコンパイルができます：

```bash
# 全ての例題をコンパイル
make all

# 特定のプログラムをコンパイル
make operators_demo

# C99版をコンパイル
make operators_demo_c99

# 全て実行
make run-all

# クリーンアップ
make clean
```

## 規格による違い

### C90での制限事項
- ビット演算子は整数型に対してのみ使用可能
- 論理演算子の結果は0または1
- ブロック先頭でのみ変数宣言可能

### C99以降の拡張
- `_Bool`型の追加により、論理値の取り扱いが明確化
- 複素数型に対する演算子の追加
- forループ内での変数宣言が可能
- インライン関数の使用が可能

## よくある間違い

### 1. 代入と比較の混同
```c
/* NG: 代入を条件文で使用 */
if (a = 5)     /* 常に真になる */
    /* ... */

/* OK: 比較演算子を使用 */
if (a == 5)    /* a が 5 と等しいかチェック */
    /* ... */
```

### 2. 整数除算の結果
```c
/* NG: 期待した結果にならない */
double result = 5 / 2;      /* 結果: 2.0 */

/* OK: 実数除算を使用 */
double result = 5.0 / 2.0;  /* 結果: 2.5 */
```

### 3. 演算子の優先順位
```c
/* NG: 意図しない計算順序 */
int result = a + b * c + d; /* b * c が先に計算される */

/* OK: 括弧で明示 */
int result = (a + b) * (c + d);
```

### 4. ビット演算の優先順位
```c
/* NG: 期待しない結果 */
if (flags & MASK == 1)      /* flags & (MASK == 1) として評価される */

/* OK: 括弧で明示 */
if ((flags & MASK) == 1)    /* 正しい評価順序 */
```

## 次の章へ

演算子と式を理解したら、[制御構造（条件分岐）](../control-if/README.md) に進んでください。

## 参考資料

- [C言語演算子リファレンス](https://ja.cppreference.com/w/c/language/operator_precedence)
- [ビット演算詳細](https://ja.cppreference.com/w/c/language/operator_arithmetic)
- [演算子優先順位表](https://ja.cppreference.com/w/c/language/operator_precedence)